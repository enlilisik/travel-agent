<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Reise-Planer Pro (Firebase Stabil)</title>

    <!-- Tailwind (dev CDN; replace for production) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        body { background-color: #F1F5F9; font-family: Inter, sans-serif; }
        .trans-all { transition: all 0.2s cubic-bezier(0.4,0,0.2,1); }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px);} to { opacity: 1; transform: translateY(0);} }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 10px; }
    </style>
</head>
<body class="text-slate-800 p-4 md:p-8 min-h-screen flex flex-col items-center justify-start">

    <!-- ================= VIEW: DASHBOARD ================= -->
    <div id="view-dashboard" class="w-full max-w-4xl fade-in">
        <header class="mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-primary to-secondary">
                    Meine Reisen
                </h1>
                <p class="text-slate-500 font-medium mt-1">Verwalte und vergleiche deine Pl√§ne</p>
            </div>
            <!-- Firebase Status Indicator -->
            <div class="flex flex-col items-end">
                <span id="firebaseStatus" class="text-xs px-2 py-1 rounded-full text-white bg-yellow-400 animate-pulse">Warte auf Firebase...</span>
            </div>
            <div class="flex gap-3">
                 <button id="compareBtn" class="px-5 py-2.5 bg-white text-slate-600 border border-slate-200 hover:border-primary hover:text-primary rounded-xl font-medium shadow-sm trans-all">
                    <i class="ph-bold ph-chart-bar"></i> Vergleichen
                </button>
                <button id="createNewTripButton" disabled class="px-5 py-2.5 bg-primary text-white hover:bg-primary-dark rounded-xl font-medium shadow-glow trans-all flex items-center gap-2">
                    <i class="ph-bold ph-plus"></i> Neue Reise
                </button>
            </div>
        </header>

        <!-- Trip Grid -->
        <div id="tripGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Cards injected via JS -->
        </div>

        <!-- Loading State -->
        <div id="dashboardLoading" class="flex flex-col items-center justify-center py-20 text-slate-400 bg-white rounded-3xl border border-dashed border-slate-300">
            <i class="ph-duotone ph-circles-three text-5xl mb-4 text-slate-300 animate-spin"></i>
            <p class="text-lg font-medium">Lade Reisen von Firebase...</p>
        </div>

        <div id="emptyDashboard" class="hidden flex-col items-center justify-center py-20 text-slate-400 bg-white rounded-3xl border border-dashed border-slate-300">
            <i class="ph-duotone ph-airplane-tilt text-5xl mb-4 text-slate-300"></i>
            <p class="text-lg font-medium">Noch keine Reisen geplant</p>
            <button id="createFirstTripBtn" class="mt-4 text-primary font-semibold hover:underline">Erste Reise anlegen</button>
        </div>
    </div>

    <!-- ================= VIEW: EDITOR (Cost Calculator) ================= -->
    <div id="view-editor" class="w-full max-w-4xl hidden fade-in">
        <header class="w-full mb-6 flex flex-col gap-4">
            <button id="backToDashboard" class="self-start text-sm text-slate-500 hover:text-primary flex items-center gap-1 trans-all">
                <i class="ph-bold ph-arrow-left"></i> Zur√ºck zur √úbersicht
            </button>

            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-white p-4 rounded-2xl shadow-soft border border-slate-100">
                <div class="flex-grow w-full md:w-auto">
                    <label class="text-xs font-bold text-slate-400 uppercase tracking-wider ml-1">Reise-Name</label>
                    <input type="text" id="tripTitleInput" class="w-full text-2xl md:text-3xl font-bold text-slate-800 bg-transparent border-b-2 border-transparent focus:border-primary p-2" />
                </div>
                <div class="flex flex-col sm:flex-row gap-4">
                    <div class="flex items-center gap-3 bg-slate-50 p-2 rounded-xl border border-slate-100">
                        <div class="flex flex-col px-2">
                            <span class="text-[10px] text-slate-400 font-bold uppercase">Reisende</span>
                            <i class="ph-fill ph-users text-primary"></i>
                        </div>
                        <div class="flex items-center bg-white rounded-lg shadow-sm">
                            <button id="travMinus" class="w-8 h-8 text-slate-400 hover:text-primary trans-all"><i class="ph-bold ph-minus"></i></button>
                            <input type="number" id="travelerCount" value="1" min="1" class="w-10 text-center font-bold outline-none text-slate-700" />
                            <button id="travPlus" class="w-8 h-8 text-primary hover:bg-slate-50 trans-all"><i class="ph-bold ph-plus"></i></button>
                        </div>
                    </div>

                    <div class="flex items-center gap-3 bg-slate-50 p-2 rounded-xl border border-slate-100">
                        <div class="flex flex-col px-2">
                            <span class="text-[10px] text-slate-400 font-bold uppercase">Tage</span>
                            <i class="ph-fill ph-calendar text-secondary"></i>
                        </div>
                        <div class="flex items-center bg-white rounded-lg shadow-sm">
                            <button id="daysMinus" class="w-8 h-8 text-slate-400 hover:text-secondary trans-all"><i class="ph-bold ph-minus"></i></button>
                            <input type="number" id="daysCount" value="7" min="1" class="w-10 text-center font-bold outline-none text-slate-700" />
                            <button id="daysPlus" class="w-8 h-8 text-secondary hover:bg-slate-50 trans-all"><i class="ph-bold ph-plus"></i></button>
                        </div>
                    </div>

                    <button id="availabilityBtn" class="px-3 py-2 bg-slate-100 text-slate-600 hover:bg-slate-200 rounded-xl font-medium shadow-sm trans-all flex items-center gap-2">
                        <i class="ph-bold ph-calendar-plus"></i> Verf√ºgbarkeit planen
                    </button>
                </div>
            </div>
        </header>

        <main class="bg-white rounded-3xl shadow-soft border border-slate-100 overflow-hidden p-6">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-4 mb-6">
                <div class="md:col-span-3">
                    <label class="text-xs font-semibold text-slate-400 ml-1">Beschreibung</label>
                    <input type="text" id="itemName" placeholder="z.B. Hotel, Flug..." class="w-full p-3 bg-white rounded-xl border border-slate-200" />
                </div>
                <div class="md:col-span-3">
                    <label class="text-xs font-semibold text-slate-400 ml-1">Link (Optional)</label>
                    <input type="url" id="itemUrl" placeholder="Link" class="w-full p-3 bg-white rounded-xl border border-slate-200" />
                </div>
                <div class="md:col-span-2">
                    <label class="text-xs font-semibold text-slate-400 ml-1">Kategorie</label>
                    <select id="itemCategory" class="w-full p-3 bg-white rounded-xl border border-slate-200">
                        <option value="transport">‚úàÔ∏è Transport</option>
                        <option value="accommodation">üõèÔ∏è Unterkunft</option>
                        <option value="food">üçî Essen & Trinken</option>
                        <option value="fun">üéüÔ∏è Spa√ü & Action</option>
                        <option value="misc">üì¶ Sonstiges</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label class="text-xs font-semibold text-slate-400 ml-1">Berechnung</label>
                    <select id="calculationType" class="w-full p-3 bg-white rounded-xl border border-slate-200">
                        <option value="total">Gesamtkosten</option>
                        <option value="daily">Kosten pro Tag</option>
                        <option value="pp">Kosten pro Person</option>
                        <option value="ppd">Kosten pro Tag & Person</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label class="text-xs font-semibold text-slate-400 ml-1">Preis (‚Ç¨)</label>
                    <input type="number" id="itemCost" placeholder="Gesamtbetrag" class="w-full p-3 text-right bg-white rounded-xl border border-slate-200" />
                </div>
            </div>

            <div class="flex gap-3">
                <button id="addExpenseButton" class="px-4 py-2 bg-primary text-white rounded-xl flex items-center gap-2">
                    <i class="ph-bold ph-plus text-xl"></i> Hinzuf√ºgen
                </button>
                <button id="cancelEditButton" class="px-4 py-2 bg-emerald-500 text-white rounded-xl hidden">Abbrechen</button>
                <div class="ml-auto text-right">
                    <div class="text-xs text-slate-400">Gesamt</div>
                    <div id="totalCostDisplay" class="text-2xl font-bold text-slate-800">‚Ç¨ 0,00</div>
                </div>
            </div>

            <ul id="expenseList" class="mt-6 space-y-3"></ul>
            <div id="editorEmptyState" class="mt-6 text-slate-400">Keine Ausgaben vorhanden</div>
        </main>
    </div>

    <!-- Availability modal (hidden) -->
    <div id="availability-modal" class="hidden modal-backdrop">
        <div class="availability-matrix-container bg-white p-6 rounded-2xl shadow-lg w-11/12 max-w-4xl">
            <h3 class="font-bold mb-3">Verf√ºgbarkeit planen</h3>
            <div id="availability-matrix-wrapper" class="overflow-x-auto"></div>
            <div class="mt-4 flex justify-end gap-2">
                <button onclick="hideAvailabilityPlanner()" class="px-4 py-2 bg-white border rounded">Schlie√üen</button>
            </div>
        </div>
    </div>

    <!-- ================= SCRIPTS (module) ================= -->
    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBALS ---
        let app, auth, db, userId, appId;
        let isFirebaseReady = false;
        let trips = [];
        let currentTripId = null;
        let editingExpenseId = null;

        // Default expenses must be defined before createNewTrip uses them
        const defaultExpenses = [
            { id: Date.now() + 1, name: "Fl√ºge / Bahn (pro Person)", cost: 250, category: 'transport', type: 'pp', url: '' },
            { id: Date.now() + 2, name: "Unterkunft (Gesamtmiete)", cost: 1200, category: 'accommodation', type: 'total', url: '' },
            { id: Date.now() + 3, name: "Verpflegung (pro Tag & Person)", cost: 45, category: 'food', type: 'ppd', url: '' },
            { id: Date.now() + 4, name: "Aktivit√§ten / Eintritt", cost: 500, category: 'fun', type: 'total', url: '' }
        ];

        const categories = {
            transport: { label: 'Transport', color: 'bg-blue-100 text-blue-700' },
            accommodation: { label: 'Unterkunft', color: 'bg-amber-100 text-amber-700' },
            food: { label: 'Essen', color: 'bg-emerald-100 text-emerald-700' },
            fun: { label: 'Spa√ü', color: 'bg-rose-100 text-rose-700' },
            misc: { label: 'Sonstiges', color: 'bg-slate-100 text-slate-700' }
        };

        const calculationTypes = {
            total: { label: 'Gesamtkosten', unit: '‚Ç¨ gesamt', icon: 'ph-check-circle', color: 'text-slate-500' },
            daily: { label: 'Kosten pro Tag', unit: '‚Ç¨ / Tag', icon: 'ph-calendar-check', color: 'text-secondary' },
            pp: { label: 'Kosten pro Person', unit: '‚Ç¨ / Person', icon: 'ph-user-check', color: 'text-primary' },
            ppd: { label: 'Kosten pro Tag & Person', unit: '‚Ç¨ / Tag/Pers.', icon: 'ph-users-four', color: 'text-rose-500' }
        };

        // UI elements
        const firebaseStatusEl = document.getElementById('firebaseStatus');
        const createNewTripButton = document.getElementById('createNewTripButton');
        const compareBtn = document.getElementById('compareBtn');
        const createFirstTripBtn = document.getElementById('createFirstTripBtn');
        const tripGrid = document.getElementById('tripGrid');
        const dashboardLoading = document.getElementById('dashboardLoading');
        const emptyDashboard = document.getElementById('emptyDashboard');

        const viewEditor = document.getElementById('view-editor');
        const viewDashboard = document.getElementById('view-dashboard');
        const backToDashboardBtn = document.getElementById('backToDashboard');

        const tripTitleInput = document.getElementById('tripTitleInput');
        const travelerCount = document.getElementById('travelerCount');
        const daysCount = document.getElementById('daysCount');
        const expenseList = document.getElementById('expenseList');
        const editorEmptyState = document.getElementById('editorEmptyState');

        const addExpenseButton = document.getElementById('addExpenseButton');
        const cancelEditButton = document.getElementById('cancelEditButton');
        const itemName = document.getElementById('itemName');
        const itemCost = document.getElementById('itemCost');
        const itemUrl = document.getElementById('itemUrl');
        const itemCategory = document.getElementById('itemCategory');
        const calculationType = document.getElementById('calculationType');
        const totalCostDisplay = document.getElementById('totalCostDisplay');

        // helper to update status
        function updateStatus(message, className = 'bg-yellow-400', ready = false) {
            if (firebaseStatusEl) {
                firebaseStatusEl.textContent = message;
                firebaseStatusEl.className = `text-xs px-2 py-1 rounded-full text-white ${className}`;
            }
            if (createNewTripButton) {
                createNewTripButton.disabled = !ready;
                createNewTripButton.classList.toggle('opacity-50', !ready);
                createNewTripButton.classList.toggle('cursor-not-allowed', !ready);
            }
        }

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyCpSBocmDnNWuhDV4zRNCJzO8DV15tGzbg",
            authDomain: "test-travel-agent-8c24c.firebaseapp.com",
            projectId: "test-travel-agent-8c24c",
            storageBucket: "test-travel-agent-8c24c.appspot.com",
            messagingSenderId: "614397992194",
            appId: "1:614397992194:web:47d8f378e887cc38d4761b",
            measurementId: "G-6SBQB59VSM"
        };

        try { setLogLevel && setLogLevel('debug'); } catch(e) { /* ignore */ }

        // --- INITIALIZE FIREBASE ---
        async function initFirebase() {
            updateStatus('Warte auf Firebase...', 'animate-pulse bg-yellow-400', false);

            if (!firebaseConfig.apiKey) {
                console.error("FIREBASE FEHLER: apiKey fehlt.");
                updateStatus('Fehler: Konfig. unvollst√§ndig (API Key)', 'bg-rose-500', false);
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
                console.log('initializeApp OK', app.options);
            } catch (e) {
                console.error("FIREBASE FEHLER: Initialisierung fehlgeschlagen:", e);
                updateStatus('Fehler: Initialisierung (Check Konsole)', 'bg-rose-500', false);
                return;
            }

            // Sign in
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } catch (err) {
                        console.warn("Custom token failed, fallback to anonymous", err);
                        await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("FIREBASE FEHLER: Anmeldung fehlgeschlagen:", err);
                updateStatus('Fehler: Anmeldung', 'bg-rose-500', false);
                return;
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isFirebaseReady = true;
                    console.log(`Firebase initialized. User ID: ${userId}`);
                    updateStatus('Verbunden', 'bg-emerald-500', true);
                    listenForTrips();
                } else {
                    console.warn("User signed out or authentication failed.");
                    updateStatus('Nicht angemeldet', 'bg-gray-500', false);
                }
            });
        }

        // --- FIRESTORE CRUD & LISTEN ---
        function getTripCollectionRef() {
            if (!db || !userId) return null;
            return collection(db, `artifacts/${appId}/users/${userId}/trips`);
        }

        function listenForTrips() {
            const col = getTripCollectionRef();
            if (!col) return;
            onSnapshot(col, (snapshot) => {
                trips = [];
                snapshot.forEach((d) => trips.push({ id: d.id, ...d.data() }));
                renderDashboard();
                if (!document.getElementById('view-editor').classList.contains('hidden') && currentTripId) {
                    loadTripIntoEditor(true);
                }
            }, (error) => {
                console.error("FIREBASE FEHLER: Fehler beim Abrufen der Reisen:", error);
                updateStatus('Fehler: Firestore Abruf', 'bg-rose-500', false);
            });
        }

        async function saveTrip(trip) {
            if (!isFirebaseReady) {
                console.error("Firebase nicht bereit. Speichern nicht m√∂glich.");
                updateStatus('Fehler: DB nicht bereit', 'bg-rose-500', false);
                return false;
            }
            try {
                const tripRef = doc(db, `artifacts/${appId}/users/${userId}/trips`, String(trip.id));
                await setDoc(tripRef, trip);
                return true;
            } catch (e) {
                console.error("Fehler beim Speichern der Reise: ", e);
                updateStatus('Fehler: Speichern', 'bg-rose-500', false);
                return false;
            }
        }

        async function removeTripFromFirestore(id) {
            if (!isFirebaseReady) return;
            try {
                const tripRef = doc(db, `artifacts/${appId}/users/${userId}/trips`, String(id));
                await deleteDoc(tripRef);
            } catch (e) {
                console.error("Fehler beim L√∂schen der Reise: ", e);
            }
        }

        // --- UI RENDERING ---
        function formatCurrency(num) {
            return Number(num || 0).toLocaleString('de-DE', { style: 'currency', currency: 'EUR' });
        }

        function renderDashboard() {
            const grid = tripGrid;
            const empty = emptyDashboard;
            const loading = dashboardLoading;

            if (!isFirebaseReady) return;
            if (trips.length === 0) {
                loading.classList.add('hidden');
                empty.classList.replace('hidden', 'flex');
                grid.innerHTML = '';
                return;
            }

            loading.classList.add('hidden');
            empty.classList.add('hidden');
            grid.innerHTML = '';

            [...trips].reverse().forEach(trip => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-2xl p-6 shadow-soft hover:shadow-lg border border-slate-100 trans-all cursor-pointer group relative overflow-hidden';
                card.dataset.id = trip.id;
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="font-bold text-xl text-slate-800">${escapeHtml(trip.title || 'Unbenannte Reise')}</h3>
                        <span class="text-xs font-bold px-2 py-1 bg-slate-100 text-slate-500 rounded-lg whitespace-nowrap">
                            <i class="ph-fill ph-users"></i> ${trip.travelers || 1} | <i class="ph-fill ph-calendar-blank"></i> ${trip.days || 1} T.
                        </span>
                    </div>
                    <div class="space-y-1 mb-6">
                        <div class="flex justify-between items-end">
                            <span class="text-sm text-slate-400 font-medium">Gesamt</span>
                            <span class="text-2xl font-bold text-slate-800">${formatCurrency(calculateTripCosts(trip).total)}</span>
                        </div>
                        <div class="flex justify-between items-end">
                            <span class="text-xs text-slate-400">pro Person</span>
                            <span class="text-sm font-semibold text-emerald-600">${formatCurrency(calculateTripCosts(trip).perPerson)}</span>
                        </div>
                    </div>
                    <div class="absolute top-4 right-4 flex gap-2">
                        <button data-action="edit" class="text-slate-400 hover:text-primary p-2"><i class="ph-bold ph-pencil"></i></button>
                        <button data-action="delete" class="text-slate-400 hover:text-rose-500 p-2"><i class="ph-bold ph-trash"></i></button>
                    </div>
                `;
                card.addEventListener('click', (e) => {
                    if (e.target.closest('button[data-action="delete"]')) return;
                    showEditor(trip.id);
                });
                card.querySelector('button[data-action="delete"]').addEventListener('click', (ev) => {
                    ev.stopPropagation();
                    if (confirm('M√∂chtest du diese Reise wirklich l√∂schen?')) removeTripFromFirestore(trip.id);
                });
                card.querySelector('button[data-action="edit"]').addEventListener('click', (ev) => {
                    ev.stopPropagation();
                    showEditor(trip.id);
                });

                grid.appendChild(card);
            });
        }

        function escapeHtml(s) {
            return String(s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
        }

        // --- TRIP LOGIC ---
        async function createNewTrip() {
            if (!isFirebaseReady) {
                updateStatus('Warte: Firebase noch nicht bereit', 'bg-yellow-400', false);
                return;
            }

            const newId = Date.now();
            const newTrip = {
                id: newId,
                title: 'Mein neuer Trip ' + (trips.length + 1),
                travelers: 2,
                days: 7,
                expenses: JSON.parse(JSON.stringify(defaultExpenses)),
                availabilities: [{ name: 'Du', days: [] }]
            };

            trips.push(newTrip);
            currentTripId = newId;

            const ok = await saveTrip(newTrip);
            if (ok) {
                renderDashboard();
                showEditor(newId);
            } else {
                trips = trips.filter(t => String(t.id) !== String(newId));
                currentTripId = null;
            }
        }

        function getActiveTrip() {
            return trips.find(t => String(t.id) === String(currentTripId));
        }

        function showEditor(id) {
            const trip = trips.find(t => String(t.id) === String(id));
            if (!trip) return showDashboard();
            currentTripId = id;
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-editor').classList.remove('hidden');
            loadTripIntoEditor();
        }

        function showDashboard() {
            document.getElementById('view-editor').classList.add('hidden');
            document.getElementById('view-dashboard').classList.remove('hidden');
            currentTripId = null;
        }

        function loadTripIntoEditor(isSilentUpdate = false) {
            const trip = getActiveTrip();
            if (!trip) return showDashboard();

            if (!isSilentUpdate) {
                tripTitleInput.value = trip.title || '';
                travelerCount.value = trip.travelers || 1;
                daysCount.value = trip.days || 1;
            }
            editingExpenseId = null;
            renderExpenseList();
            recalculateEditor();
        }

        function renderExpenseList() {
            const trip = getActiveTrip();
            expenseList.innerHTML = '';
            if (!trip || !trip.expenses || trip.expenses.length === 0) {
                editorEmptyState.classList.remove('hidden');
                return;
            }
            editorEmptyState.classList.add('hidden');
            trip.expenses.slice().reverse().forEach(e => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between p-4 bg-white border rounded';
                li.innerHTML = `
                    <div>
                        <div class="font-semibold">${escapeHtml(e.name)}</div>
                        <div class="text-xs text-slate-500">${escapeHtml(e.category)} ‚Ä¢ ${Number(e.cost).toFixed(2)} ${calculationTypes[e.type]?.unit || ''}</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-bold">${formatCurrency(calculateExpenseCost(e, (trip.travelers||1), (trip.days||1)).finalCost)}</span>
                        <button class="text-rose-500 remove-expense" data-id="${e.id}"><i class="ph-bold ph-trash"></i></button>
                    </div>
                `;
                expenseList.appendChild(li);
            });
        }

        // Expense calculation
        function calculateExpenseCost(expense, travelers, days) {
            let baseCost = Number(expense.cost) || 0;
            let finalCost = baseCost;
            if (expense.type === 'daily' || expense.type === 'daily') {
                finalCost = baseCost * days;
            } else if (expense.type === 'pp') {
                finalCost = baseCost * travelers;
            } else if (expense.type === 'ppd') {
                finalCost = baseCost * days * travelers;
            }
            return { finalCost, baseCost };
        }

        function calculateTripCosts(trip) {
            if (!trip || !trip.expenses) return { total: 0, perPerson: 0 };
            const total = trip.expenses.reduce((sum, e) => sum + (calculateExpenseCost(e, trip.travelers, trip.days).finalCost || 0), 0);
            const perPerson = total / (trip.travelers || 1);
            return { total, perPerson };
        }

        function recalculateEditor() {
            const trip = getActiveTrip();
            if (!trip) return;
            const { total, perPerson } = calculateTripCosts(trip);
            totalCostDisplay.innerText = formatCurrency(total);
        }

        // --- Editor Interactions ---
        addExpenseButton.addEventListener('click', async () => {
            const trip = getActiveTrip();
            if (!trip) return;
            const name = itemName.value.trim();
            const cost = parseFloat(itemCost.value);
            const url = itemUrl.value.trim();
            const category = itemCategory.value;
            const type = calculationType.value;

            if (!name || isNaN(cost)) {
                itemName.classList.add('ring-2', 'ring-rose-500', 'bg-rose-50');
                setTimeout(() => itemName.classList.remove('ring-2','ring-rose-500','bg-rose-50'), 600);
                return;
            }

            if (editingExpenseId !== null) {
                const idx = trip.expenses.findIndex(e => e.id === editingExpenseId);
                if (idx !== -1) trip.expenses[idx] = { ...trip.expenses[idx], name, cost, url, category, type };
            } else {
                trip.expenses.push({ id: Date.now(), name, cost, url, category, type });
            }

            const ok = await saveTrip(trip);
            if (ok) {
                itemName.value = ''; itemCost.value = ''; itemUrl.value = '';
                editingExpenseId = null;
                renderExpenseList();
                recalculateEditor();
            }
        });

        // Delegated remove-expense
        expenseList.addEventListener('click', async (ev) => {
            const btn = ev.target.closest('.remove-expense');
            if (!btn) return;
            const id = btn.dataset.id;
            const trip = getActiveTrip();
            if (!trip) return;
            trip.expenses = trip.expenses.filter(e => String(e.id) !== String(id));
            await saveTrip(trip);
            renderExpenseList();
            recalculateEditor();
        });

        // Title / travelers / days changes
        tripTitleInput.addEventListener('change', async () => {
            const trip = getActiveTrip();
            if (!trip) return;
            trip.title = tripTitleInput.value || 'Unbenannt';
            await saveTrip(trip);
            renderDashboard();
        });
        travelerCount.addEventListener('change', async () => {
            const trip = getActiveTrip();
            if (!trip) return;
            trip.travelers = parseInt(travelerCount.value) || 1;
            await saveTrip(trip);
            recalculateEditor();
            renderDashboard();
        });
        daysCount.addEventListener('change', async () => {
            const trip = getActiveTrip();
            if (!trip) return;
            trip.days = parseInt(daysCount.value) || 1;
            trip.availabilities && trip.availabilities.forEach(p => p.days = p.days.filter(d => d < trip.days));
            await saveTrip(trip);
            recalculateEditor();
            renderDashboard();
        });

        // Back button
        backToDashboardBtn.addEventListener('click', () => {
            showDashboard();
        });

        // Availability modal handlers (simple)
        function showAvailabilityPlanner() { document.getElementById('availability-modal').classList.remove('hidden'); }
        function hideAvailabilityPlanner() {
            document.getElementById('availability-modal').classList.add('hidden');
            const trip = getActiveTrip(); if (trip) saveTrip(trip);
        }

        // --- Utility: expose methods for inline calls (compat) ---
        window.createNewTrip = createNewTrip;
        window.showEditor = showEditor;
        window.showDashboard = showDashboard;
        window.showAvailabilityPlanner = showAvailabilityPlanner;
        window.hideAvailabilityPlanner = hideAvailabilityPlanner;

        // --- Top-level UI wiring ---
        createNewTripButton.addEventListener('click', createNewTrip);
        compareBtn.addEventListener('click', () => { alert('Vergleichsansicht noch nicht implementiert in dieser Version'); });
        createFirstTripBtn && createFirstTripBtn.addEventListener('click', createNewTrip);

        // +/- buttons on editor
        document.getElementById('travMinus').addEventListener('click', () => { travelerCount.value = Math.max(1, parseInt(travelerCount.value||1) - 1); travelerCount.dispatchEvent(new Event('change'));});
        document.getElementById('travPlus').addEventListener('click', () => { travelerCount.value = Math.max(1, parseInt(travelerCount.value||1) + 1); travelerCount.dispatchEvent(new Event('change'));});
        document.getElementById('daysMinus').addEventListener('click', () => { daysCount.value = Math.max(1, parseInt(daysCount.value||1) - 1); daysCount.dispatchEvent(new Event('change'));});
        document.getElementById('daysPlus').addEventListener('click', () => { daysCount.value = Math.max(1, parseInt(daysCount.value||1) + 1); daysCount.dispatchEvent(new Event('change'));});
        document.getElementById('availabilityBtn').addEventListener('click', showAvailabilityPlanner);

        // Init on load
        window.onload = () => { initFirebase(); };

    </script>
</body>
</html>
